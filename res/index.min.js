define(["exports","tslib","@hpcc-js/common","@hpcc-js/comms","@hpcc-js/composite","@hpcc-js/form","@hpcc-js/map","@hpcc-js/other","@hpcc-js/chart","@hpcc-js/dgrid","@hpcc-js/layout","@hpcc-js/graph"],(function(e,t,r,i,s,o,n,a,u,l,p,c){var h=function(e){function r(){return null!==e&&e.apply(this,arguments)||this}return t.__extends(r,e),r}(p.Grid);h.prototype._class+=" visualizer_VisualizerGrid",h.prototype.publish("maxRowCount",1e4,"number");var d=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t._filter={},t._table=new l.Table,t}return t.__extends(r,e),r.prototype.update=function(t,r){e.prototype.update.call(this,t,r)},r.prototype.render=function(t){var r=this;if(0===this._renderCount){var i=this.data().length;this.data().forEach((function(e,t){var i=e[0],s=(new u.Column).columns(["Field ID","Row Count"]).data(e[2].map((function(e){return[e.value,e.rowcount]}))).on("click",(function(e,t,s){s?r._filter[i]=e["Field ID"]:delete r._filter[i],r.refreshFilter()}));r.setContent(0,t,s,"".concat(e[0]," (").concat(e[1],")"))})),this.setContent(i?1:0,0,this._table,"",2,i),this.refreshFilter()}return e.prototype.render.apply(this,arguments)},r.prototype.refreshFilter=function(){var e=this;i.Result.attach({baseUrl:this.baseUrl()},this.logicalFile(),void 0).fetchRows(0,this.maxRowCount(),!1,this._filter).then((function(t){var r=[],i={},s=t.map((function(e,t){var s=[];return 0===t&&Object.keys(e).forEach((function(e,t){r.push(e),i[e]=t})),Object.keys(e).forEach((function(t){s[i[t]]=e[t]})),s}));e._table.columns(r).data(s).render()}))},r.prototype.click=function(e,t,r){},r}(h);d.prototype._class+=" visualizer_Dashboard",d.prototype.publish("baseUrl",null,"string"),d.prototype.publish("logicalFile",null,"string");var f="__hpcc_visualization",g=function(e){function r(t){var r=e.call(this)||this;return r._id="",r._columns=[],r._data=[],r._metaResult=t,r._id=r._metaResult.name(),r._columns=[],r._data=[],r}return t.__extends(r,e),r.prototype.mapData=function(e){var t=this.mappings();return t.length?e.map((function(e){for(var r={},i=0,s=t;i<s.length;i++){var o=s[i];r[o.key]=e[o.value.toLowerCase()]}return r})):e},r.prototype.refreshData=function(e,t){var r=this;void 0===e&&(e={}),void 0===t&&(t=-1);var i,s={},o=!1,n=0;(this.filteredBy().forEach((function(t){var r=e[t.source+f];r&&(++n,t.mappings.forEach((function(e){s[e.value.toLowerCase()]=r.row[e.key]||r.row[e.key.toLowerCase()]}))),o=!0}),this),!o||n>0)?i=a.createResult(this._metaResult.url(),this.dataSource(),this.resultName()).query({Start:0,Count:t},s).then((function(e){return a.flattenResult(e,r.mappings())})):i=Promise.resolve({columns:[],data:[]});return i},r}(r.PropertyExt);g.prototype._class+=" WUWudget",g.prototype.publish("widgetClassID",null,"string","ESP Url"),g.prototype.publish("widgetClass",null,"object","Widget Class Declaration"),g.prototype.publish("dataSource",null,"string","Data Source"),g.prototype.publish("resultName",null,"string","Result Name"),g.prototype.publish("mappings",null,"object","Widget Mappings"),g.prototype.publish("filteredBy",null,"object","Widget Filter Properties"),g.prototype.publish("properties",null,"object","Widget Properties");var _=function(e){function r(t){var r=e.call(this)||this;return r._id="",r._columns=[],r._data=[],r._metaResult=t,r._id=r._metaResult.name(),r._columns=[],r._data=[],r}return t.__extends(r,e),r.prototype.createWidget=function(){var e=(new(this.widgetClass())).id(this.id());return this.properties().forEach((function(t){"function"==typeof e[t.key]&&e[t.key](t.value)})),e},r.prototype.parseClassID=function(e){var t=e.split("_");return{pkg:"@hpcc-js/"+t[0],def:t[1]}},r.prototype.requireWidget=function(e){var t=this;return new Promise((function(r,i){var s=t.parseClassID(e);if("@hpcc-js/visualizer"===s.pkg){if("Dashboard"===s.def)r(d)}else require([s.pkg],(function(e){r(e[s.def])}))}))},r.prototype.resolveWidget=function(){var e=this;return this.requireWidget(e.widgetClassID()).then((function(t){e.widgetClass(t)}))},r.prototype.resolve=function(){var e=this;return this._metaResult.query().then((function(t){return t&&t.length?t[0].vertices?e.widgetClassID(t[0].classid).verticesMeta(new g(e._metaResult).widgetClassID(t[0].vertices[0].classid).dataSource(t[0].vertices[0].datasource||e._metaResult.wuid()).resultName(t[0].vertices[0].resultname).mappings(t[0].vertices[0].mappings).filteredBy(t[0].vertices[0].filteredby).properties(t[0].vertices[0].properties)).edgesMeta(new g(e._metaResult).widgetClassID(t[0].edges[0].classid).dataSource(t[0].edges[0].datasource||e._metaResult.wuid()).resultName(t[0].edges[0].resultname).mappings(t[0].edges[0].mappings).filteredBy(t[0].edges[0].filteredby).properties(t[0].edges[0].properties)).filteredBy(t[0].filteredby).properties(t[0].properties):(t[0].properties.push({key:"baseUrl",value:"".concat(e._metaResult._protocol,"//").concat(e._metaResult._host,"/")}),e.widgetClassID(t[0].classid).widgetMeta(new g(e._metaResult).widgetClassID(t[0].classid).dataSource(t[0].datasource||e._metaResult.wuid()).resultName(t[0].resultname).mappings(t[0].mappings).filteredBy(t[0].filteredby).properties(t[0].properties)).filteredBy(t[0].filteredby).properties(t[0].properties)):console.log("Visualizer meta-data is empty."),e.resolveWidget().then((function(){return e}))}))},r.prototype.refreshData=function(e,t){var r=this;void 0===e&&(e={}),void 0===t&&(t=-1);var i=this.widget();return i instanceof c.Graph?Promise.all([this.verticesMeta().refreshData(e,t),this.edgesMeta().refreshData({},-1)]).then((function(e){return r.refreshGraph(i,e[0].data,r.verticesMeta().properties(),e[1].data,r.edgesMeta().properties())})):this.widgetMeta().refreshData(e,t).then((function(e){return r.refreshWidget(i,e)}))},r.prototype.refreshWidget=function(e,t){e.columns(t.columns).data(t.data).lazyRender()},r.prototype.refreshGraph=function(e,t,r,i,s){var o={},n=t.map((function(e){var t=(new c.Vertex).text(e[1]);return e[2]?t.faChar(e[2]):t.icon_diameter(0),r.forEach((function(e){"function"==typeof t[e.key]&&t[e.key](e.value)})),o[e[0]]=t,t})),a=i.map((function(e){var t=o[e[0]],r=o[e[1]];if(t&&r){var i=(new c.Edge).sourceVertex(t).targetVertex(r).text(e[2]);return e[2]&&i.text(e[2]),s.forEach((function(e){"function"==typeof i[e.key]&&i[e.key](e.value)})),i}t?console.log("Invalid edge - no target vertex."):r?console.log("Invalid edge - no source vertex."):console.log("Invalid edge - no source or target verticies.")})).filter((function(e){return!!e}));e.data({vertices:n,edges:a}).lazyRender()},r}(r.Widget);_.prototype._class+=" WUWudget",_.prototype.publish("widgetClassID",null,"string"),_.prototype.publish("widgetClass",null,"object","Widget Class Declaration"),_.prototype.publish("widget",null,"object","Widget Instance"),_.prototype.publish("widgetMeta",null,"object"),_.prototype.publish("verticesMeta",null,"object"),_.prototype.publish("edgesMeta",null,"object"),_.prototype.publish("filteredBy",null,"object","Widget Filter Properties"),_.prototype.publish("properties",null,"object","Widget Properties"),n.topoJsonFolder("https://unpkg.com/@hpcc-js/map@2.0.0/TopoJSON"),a.enableCache(!0);var y="HPCC-Visualizer",v="persist",m=function(){function e(e){this._wuWidgets=[],this._wuWidgetMap={},this._wuDashSel={},this._espUrl=e,this._espWorkunit=a.createConnection(this._espUrl),this._wuWidgets=[],this._wuWidgetMap={},this._wuDashSel={}}return e.prototype.resetPersist=function(){return this._espWorkunit.appData(y,v," ")},e.prototype.submitPersist=function(){if(this.grid){var e=a.Persist.serialize(this.grid);this._espWorkunit.appData(y,v,e)}},e.prototype.fetchPersist=function(){return this._espWorkunit.appData(y,v).then((function(e){if(e){var t=JSON.parse(e);switch(t.__class){case"visualizer_Dashboard":return s.Persist.deserializeFromObject(new d,t);case"visualizer_VisualizerGrid":return s.Persist.deserializeFromObject(new h,t);default:return s.Persist.create(e)}}return Promise.resolve(null)})).catch((function(e){return Promise.resolve(null)}))},e.prototype.fetchWUWidgets=function(){return this._espWorkunit.results().then((function(e){var t=[];return e.filter((function(e){return r.Utility.endsWith(e.name(),f)})).forEach((function(e){var r=new _(e);t.push(r.resolve())})),Promise.all(t)}))},e.prototype.createGrid=function(){var e=this;return Promise.all([this.fetchPersist(),this.fetchWUWidgets()]).then((function(r){e.grid=r[0],e._wuWidgets=[],e._wuWidgetMap={};var s=r[1];if(!e.grid){if(1===s.length&&s[0].widgetClass()===d)return e.grid=s[0].createWidget(),s[0].widget(e.grid),s[0].refreshData({},e.grid.maxRowCount()).then((function(){return e.grid}));e.grid=new h}var o=Math.ceil(Math.sqrt(s.length)),n=Math.ceil(s.length/o),a=3*(o+1),u=3*(n+1);return e.grid.snappingColumns(a).snappingRows(u),s.forEach((function(r,s){return t.__awaiter(this,void 0,void 0,(function(){var s,n,a,u,l,p,c=this;return t.__generator(this,(function(h){switch(h.label){case 0:if(!(s=e.grid.getContent(r.id()))){for(n=0,a=0,3,s=r.createWidget();null!==e.grid.getCell(3*n,3*a);)++a>=o&&(a=0,++n);e.grid.setContent(3*n,3*a,s,null,3,3)}switch(s.classID()){case"observable-md_ObservableMD":case"observable-md_Observable":return[3,1];case"graph_Graph":return[3,4]}return[3,5];case 1:return[4,i.Workunit.attach({baseUrl:"".concat(e._espWorkunit._protocol,"//").concat(e._espWorkunit._host)},e._espWorkunit._wuid)];case 2:return[4,(u=h.sent()).fetchResults()];case 3:return l=h.sent(),p={wuid:function(){return u.Wuid},outputs:function(){return l.map((function(e){return{name:e.Name,count:e.Total,value:e.Value,logicalFile:e.LogicalFileName}}))}},l.forEach((function(e){p[e.Name]=function(){return t.__awaiter(c,void 0,void 0,(function(){return t.__generator(this,(function(t){return[2,e.fetchRows()]}))}))}})),s.plugins(p),[3,6];case 4:return s.on("vertex_click",(function(t,r,i){e.refreshFilters(this.id(),t,r,i)})),[3,6];case 5:s.on("click",(function(t,r,i){e.refreshFilters(this.id(),t,r,i)})),h.label=6;case 6:return s._wuMeta=r,r.widget(s),e._wuWidgets.push(r),e._wuWidgetMap[r.id()]=r,[2]}}))}))})),e.grid}))},e.prototype.refresh=function(){var e=this;this._wuWidgets.forEach((function(t){t.refreshData(e._wuDashSel,e.grid.maxRowCount())}))},e.prototype.refreshFilters=function(e,t,r,i){var s=this;i?this._wuDashSel[e]={row:t,col:r}:delete this._wuDashSel[e],this._wuWidgets.forEach((function(t){t.filteredBy().forEach((function(r){e===r.source+f&&t.refreshData(s._wuDashSel,s.grid.maxRowCount())}))}))},e}(),w=function(e){function r(){return e.call(this)||this}return t.__extends(r,e),r.prototype.toggleProperties=function(){var e=s.Dermatology.prototype.toggleProperties.apply(this,arguments);return this._showProperties||this.wuDashboard.submitPersist(),e},r.prototype.reset=function(){var e=this;this.wuDashboard.resetPersist().then((function(t){a.cache({}),delete e._prevEspUrl,e.render((function(e){}))}))},r.prototype.enter=function(){s.Dermatology.prototype.enter.apply(this,arguments);var e=this;this._resetButton=(new o.Button).id(this.id()+"_reset").value("Reset").on("click",(function(){e.reset()})),this._toolbar.widgets([this._resetButton,this._propsButton])},r.prototype.update=function(){if(s.Dermatology.prototype.update.apply(this,arguments),this._prevEspUrl!==this.espUrl()){this._prevEspUrl=this.espUrl(),this.espCache()&&a.cache(JSON.parse(this.espCache()));var e=this;this.wuDashboard=new m(this.espUrl()),this.wuDashboard.createGrid().then((function(t){e.widget(t).render((function(t){e.wuDashboard.refresh()}))}))}},r}(s.Dermatology);w.prototype._class+=" BundleDermatology",w.prototype.publish("espUrl",null,"string","ESP Url"),w.prototype.publish("espCache",null,"string","ESP Cache"),e.BundleDermatology=w,e.WUDashboard=m,Object.defineProperty(e,"__esModule",{value:!0})}));