define(["exports","tslib","@hpcc-js/common","@hpcc-js/composite","@hpcc-js/form","@hpcc-js/map","@hpcc-js/other","@hpcc-js/chart","@hpcc-js/comms","@hpcc-js/dgrid","@hpcc-js/layout","@hpcc-js/graph"],function(e,t,s,r,i,o,a,n,l,u,p,c){"use strict";var h,d=(h=p.Grid,t.__extends(f,h),f);function f(){return null!==h&&h.apply(this,arguments)||this}d.prototype._class+=" visualizer_VisualizerGrid",d.prototype.publish("maxRowCount",1e4,"number");var g,y=(g=d,t.__extends(_,g),_.prototype.update=function(e,t){g.prototype.update.call(this,e,t)},_.prototype.render=function(e){var i=this;if(0===this._renderCount){var t=this.data().length;this.data().forEach(function(e,t){var s=e[0],r=(new n.Column).columns(["Field ID","Row Count"]).data(e[2].map(function(e){return[e.value,e.rowcount]})).on("click",function(e,t,r){r?i._filter[s]=e["Field ID"]:delete i._filter[s],i.refreshFilter()});i.setContent(0,t,r,e[0]+" ("+e[1]+")")}),this.setContent(t?1:0,0,this._table,"",2,t),this.refreshFilter()}return g.prototype.render.apply(this,arguments)},_.prototype.refreshFilter=function(){var r=this;l.Result.attach({baseUrl:this.baseUrl()},this.logicalFile(),void 0).fetchRows(0,this.maxRowCount(),!1,this._filter).then(function(e){var s=[],i={},t=e.map(function(t,e){var r=[];return 0===e&&Object.keys(t).forEach(function(e,t){s.push(e),i[e]=t}),Object.keys(t).forEach(function(e){r[i[e]]=t[e]}),r});r._table.columns(s).data(t).render()})},_.prototype.click=function(e,t,r){},_);function _(){var e=null!==g&&g.apply(this,arguments)||this;return e._filter={},e._table=new u.Table,e}y.prototype._class+=" visualizer_Dashboard",y.prototype.publish("baseUrl",null,"string"),y.prototype.publish("logicalFile",null,"string");var v,m="__hpcc_visualization",w=(v=s.PropertyExt,t.__extends(b,v),b.prototype.mapData=function(e){var o=this.mappings();return o.length?e.map(function(e){for(var t={},r=0,s=o;r<s.length;r++){var i=s[r];t[i.key]=e[i.value.toLowerCase()]}return t}):e},b.prototype.refreshData=function(r,e){var t=this;void 0===r&&(r={}),void 0===e&&(e=-1);var s={},i=!1,o=0;return this.filteredBy().forEach(function(e){var t=r[e.source+m];t&&(++o,e.mappings.forEach(function(e){s[e.value.toLowerCase()]=t.row[e.key]||t.row[e.key.toLowerCase()]})),i=!0},this),!i||0<o?a.createResult(this._metaResult.url(),this.dataSource(),this.resultName()).query({Start:0,Count:e},s).then(function(e){return a.flattenResult(e,t.mappings())}):Promise.resolve({columns:[],data:[]})},b);function b(e){var t=v.call(this)||this;return t._id="",t._columns=[],t._data=[],t._metaResult=e,t._id=t._metaResult.name(),t._columns=[],t._data=[],t}w.prototype._class+=" WUWudget",w.prototype.publish("widgetClassID",null,"string","ESP Url"),w.prototype.publish("widgetClass",null,"object","Widget Class Declaration"),w.prototype.publish("dataSource",null,"string","Data Source"),w.prototype.publish("resultName",null,"string","Result Name"),w.prototype.publish("mappings",null,"object","Widget Mappings"),w.prototype.publish("filteredBy",null,"object","Widget Filter Properties"),w.prototype.publish("properties",null,"object","Widget Properties");var D,C=(D=s.Widget,t.__extends(W,D),W.prototype.createWidget=function(){var t=(new(this.widgetClass())).id(this.id());return this.properties().forEach(function(e){"function"==typeof t[e.key]&&t[e.key](e.value)}),t},W.prototype.parseClassID=function(e){var t=e.split("_");return{pkg:"@hpcc-js/"+t[0],def:t[1]}},W.prototype.requireWidget=function(s){var i=this;return new Promise(function(t,e){var r=i.parseClassID(s);if("@hpcc-js/visualizer"===r.pkg)switch(r.def){case"Dashboard":t(y)}else require([r.pkg],function(e){t(e[r.def])})})},W.prototype.resolveWidget=function(){var t=this;return this.requireWidget(t.widgetClassID()).then(function(e){t.widgetClass(e)})},W.prototype.resolve=function(){var t=this;return this._metaResult.query().then(function(e){return e&&e.length?e[0].vertices?t.widgetClassID(e[0].classid).verticesMeta(new w(t._metaResult).widgetClassID(e[0].vertices[0].classid).dataSource(e[0].vertices[0].datasource||t._metaResult.wuid()).resultName(e[0].vertices[0].resultname).mappings(e[0].vertices[0].mappings).filteredBy(e[0].vertices[0].filteredby).properties(e[0].vertices[0].properties)).edgesMeta(new w(t._metaResult).widgetClassID(e[0].edges[0].classid).dataSource(e[0].edges[0].datasource||t._metaResult.wuid()).resultName(e[0].edges[0].resultname).mappings(e[0].edges[0].mappings).filteredBy(e[0].edges[0].filteredby).properties(e[0].edges[0].properties)).filteredBy(e[0].filteredby).properties(e[0].properties):(e[0].properties.push({key:"baseUrl",value:t._metaResult._protocol+"//"+t._metaResult._host+"/"}),t.widgetClassID(e[0].classid).widgetMeta(new w(t._metaResult).widgetClassID(e[0].classid).dataSource(e[0].datasource||t._metaResult.wuid()).resultName(e[0].resultname).mappings(e[0].mappings).filteredBy(e[0].filteredby).properties(e[0].properties)).filteredBy(e[0].filteredby).properties(e[0].properties)):console.log("Visualizer meta-data is empty."),t.resolveWidget().then(function(){return t})})},W.prototype.refreshData=function(e,t){var r=this;void 0===e&&(e={}),void 0===t&&(t=-1);var s=this.widget();return s instanceof c.Graph?Promise.all([this.verticesMeta().refreshData(e,t),this.edgesMeta().refreshData({},-1)]).then(function(e){return r.refreshGraph(s,e[0].data,r.verticesMeta().properties(),e[1].data,r.edgesMeta().properties())}):this.widgetMeta().refreshData(e,t).then(function(e){return r.refreshWidget(s,e)})},W.prototype.refreshWidget=function(e,t){e.columns(t.columns).data(t.data).lazyRender()},W.prototype.refreshGraph=function(e,t,r,s,i){var o={},a=t.map(function(e){var t=(new c.Vertex).text(e[1]);return e[2]?t.faChar(e[2]):t.icon_diameter(0),r.forEach(function(e){"function"==typeof t[e.key]&&t[e.key](e.value)}),o[e[0]]=t}),n=s.map(function(e){var t=o[e[0]],r=o[e[1]];if(t&&r){var s=(new c.Edge).sourceVertex(t).targetVertex(r).text(e[2]);return e[2]&&s.text(e[2]),i.forEach(function(e){"function"==typeof s[e.key]&&s[e.key](e.value)}),s}t?console.log("Invalid edge - no target vertex."):r?console.log("Invalid edge - no source vertex."):console.log("Invalid edge - no source or target verticies.")}).filter(function(e){return!!e});e.data({vertices:a,edges:n}).lazyRender()},W);function W(e){var t=D.call(this)||this;return t._id="",t._columns=[],t._data=[],t._metaResult=e,t._id=t._metaResult.name(),t._columns=[],t._data=[],t}C.prototype._class+=" WUWudget",C.prototype.publish("widgetClassID",null,"string"),C.prototype.publish("widgetClass",null,"object","Widget Class Declaration"),C.prototype.publish("widget",null,"object","Widget Instance"),C.prototype.publish("widgetMeta",null,"object"),C.prototype.publish("verticesMeta",null,"object"),C.prototype.publish("edgesMeta",null,"object"),C.prototype.publish("filteredBy",null,"object","Widget Filter Properties"),C.prototype.publish("properties",null,"object","Widget Properties"),o.topoJsonFolder("https://unpkg.com/@hpcc-js/map@2.0.0/TopoJSON"),a.enableCache(!0);var P="HPCC-Visualizer",j="persist",R=(k.prototype.resetPersist=function(){return this._espWorkunit.appData(P,j," ")},k.prototype.submitPersist=function(){if(this.grid){var e=a.Persist.serialize(this.grid);this._espWorkunit.appData(P,j,e)}},k.prototype.fetchPersist=function(){return this._espWorkunit.appData(P,j).then(function(e){if(e){var t=JSON.parse(e);switch(t.__class){case"visualizer_Dashboard":return r.Persist.deserializeFromObject(new y,t);case"visualizer_VisualizerGrid":return r.Persist.deserializeFromObject(new d,t);default:return r.Persist.create(e)}}return Promise.resolve(null)}).catch(function(e){return Promise.resolve(null)})},k.prototype.fetchWUWidgets=function(){return this._espWorkunit.results().then(function(e){var r=[];return e.filter(function(e){return s.Utility.endsWith(e.name(),m)}).forEach(function(e){var t=new C(e);r.push(t.resolve())}),Promise.all(r)})},k.prototype.createGrid=function(){var a=this;return Promise.all([this.fetchPersist(),this.fetchWUWidgets()]).then(function(e){a.grid=e[0],a._wuWidgets=[],a._wuWidgetMap={};var t=e[1];if(!a.grid){if(1===t.length&&t[0].widgetClass()===y)return a.grid=t[0].createWidget(),t[0].widget(a.grid),t[0].refreshData({},a.grid.maxRowCount()).then(function(){return a.grid});a.grid=new d}var o=Math.ceil(Math.sqrt(t.length)),r=Math.ceil(t.length/o),s=3*(o+1),i=3*(r+1);return a.grid.snappingColumns(s).snappingRows(i),t.forEach(function(e,t){var r=a.grid.getContent(e.id());if(!r){var s=0,i=0;for(r=e.createWidget();null!==a.grid.getCell(3*s,3*i);)o<=++i&&(i=0,++s);a.grid.setContent(3*s,3*i,r,null,3,3)}switch(r.classID()){case"graph_Graph":r.on("vertex_click",function(e,t,r){a.refreshFilters(this.id(),e,t,r)});break;default:r.on("click",function(e,t,r){a.refreshFilters(this.id(),e,t,r)})}(r._wuMeta=e).widget(r),a._wuWidgets.push(e),a._wuWidgetMap[e.id()]=e}),a.grid})},k.prototype.refresh=function(){var t=this;this._wuWidgets.forEach(function(e){e.refreshData(t._wuDashSel,t.grid.maxRowCount())})},k.prototype.refreshFilters=function(r,e,t,s){var i=this;s?this._wuDashSel[r]={row:e,col:t}:delete this._wuDashSel[r],this._wuWidgets.forEach(function(t){t.filteredBy().forEach(function(e){r===e.source+m&&t.refreshData(i._wuDashSel,i.grid.maxRowCount())})})},k);function k(e){this._wuWidgets=[],this._wuWidgetMap={},this._wuDashSel={},this._espUrl=e,this._espWorkunit=a.createConnection(this._espUrl),this._wuWidgets=[],this._wuWidgetMap={},this._wuDashSel={}}var x,E=(x=r.Dermatology,t.__extends(M,x),M.prototype.toggleProperties=function(){var e=r.Dermatology.prototype.toggleProperties.apply(this,arguments);return this._showProperties||this.wuDashboard.submitPersist(),e},M.prototype.reset=function(){var t=this;this.wuDashboard.resetPersist().then(function(e){a.cache({}),delete t._prevEspUrl,t.render(function(e){})})},M.prototype.enter=function(){r.Dermatology.prototype.enter.apply(this,arguments);var e=this;this._resetButton=(new i.Button).id(this.id()+"_reset").value("Reset").on("click",function(){e.reset()}),this._toolbar.widgets([this._resetButton,this._propsButton])},M.prototype.update=function(){if(r.Dermatology.prototype.update.apply(this,arguments),this._prevEspUrl!==this.espUrl()){this._prevEspUrl=this.espUrl(),this.espCache()&&a.cache(JSON.parse(this.espCache()));var t=this;this.wuDashboard=new R(this.espUrl()),this.wuDashboard.createGrid().then(function(e){t.widget(e).render(function(e){t.wuDashboard.refresh()})})}},M);function M(){return x.call(this)||this}E.prototype._class+=" BundleDermatology",E.prototype.publish("espUrl",null,"string","ESP Url"),E.prototype.publish("espCache",null,"string","ESP Cache"),e.BundleDermatology=E,e.WUDashboard=R,Object.defineProperty(e,"__esModule",{value:!0})});